<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Log Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/19da31ded3.js" crossorigin="anonymous"></script>
    <link rel="icon" href="{{ url_for('static', filename='icons/icon-192.png') }}" type="image/png">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/logger.css') }}" />
    <meta property="og:title" content="TrackPulse Vic" />
    <meta property="og:type" content="website" />
    <meta property="og:description" content="View your Train Journeys logged with Trackpulse Vic online" />

    <!-- Analytics -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "qup8z0zsv8");
    </script>

    <style>
        /* Loading animation styles */
        .log-card {
            position: relative;
            display: flex;
            align-items: center;
        }

        .log-image {
            transition: opacity 0.3s ease;
            max-width: 100px;
            margin-right: 20px;
        }

        .log-image.loading {
            opacity: 0;
        }

        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .log-background {
            z-index: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .log-details {
            position: relative;
            z-index: 1;
        }

        .image-container {
            position: relative;
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="filters-container">
        <form method="GET" action="{{ url_for('viewer') }}">
            <div class="filter-group">
                <label for="lineFilter">Line:</label>
                <select id="lineFilter" name="line">
                    <option value="">All Lines</option>
                    {% for line in lines %}
                        <option value="{{ line }}" {% if line == selected_line %}selected{% endif %}>{{ line }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="typeFilter">Train Type:</label>
                <select id="typeFilter" name="type">
                    <option value="">All Types</option>
                    {% for type in types %}
                        <option value="{{ type }}" {% if type == selected_type %}selected{% endif %}>{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="fromFilter">From Station:</label>
                <input type="text" id="fromFilter" name="from_station" value="{{ from_station }}" placeholder="Enter station">
            </div>
            <div class="filter-group">
                <label for="toFilter">To Station:</label>
                <input type="text" id="toFilter" name="to_station" value="{{ to_station }}" placeholder="Enter station">
            </div>
            <div class="filter-group">
                <label for="startDate">Start Date:</label>
                <input type="date" id="startDate" name="start_date" value="{{ start_date }}">
                <label for="endDate">End Date:</label>
                <input type="date" id="endDate" name="end_date" value="{{ end_date }}">
            </div>
            <div class="filter-group">
                <label for="sortOrder">Sort by:</label>
                <select id="sortOrder" name="sort_order">
                    <option value="desc" {% if sort_order == 'desc' %}selected{% endif %}>Newest</option>
                    <option value="asc" {% if sort_order == 'asc' %}selected{% endif %}>Oldest</option>
                </select>
            </div>
            <button type="submit" class="filter-button">Apply Filters</button>
        </form>
    </div>

    <div id="logsContainer">
        {% for log in logs %}
            <div class="log-card" style="border-left: 5px solid {{ line_colors.get(log.line, '#666') }}">
                <div class="log-background {% if enable_background %}log-background-enabled{% endif %}" data-src="{{ log.image_url }}"></div>
                <div class="image-container">
                    <a href="https://railway-photos.xm9g.net?number={{ log.link_number|urlencode }}&referer=logviewer" target="_blank">
                        <img class="log-image" data-src="{{ log.image_url }}" alt="{{ log.type }} {{ log.set }}" src="{{ log.image_url }}">
                    </a>
                </div>
                <div class="log-details">
                    <div class="field log-number">
                        <span class="field-name">Log:</span>
                        <span class="field-value"><code class="codeblock">{{ log.log_id }}</code></span>
                    </div>
                    <div class="field">
                        <span class="field-name">Set:</span>
                        <span class="field-value">{{ log.set }} ({{ log.type }})</span>
                    </div>
                    <div class="field">
                        <span class="field-name">Line:</span>
                        <span class="field-value">{{ log.line }}</span>
                    </div>
                    <div class="field">
                        <span class="field-name">Date:</span>
                        <span class="field-value">{{ log.date }}</span>
                    </div>
                    <div class="field">
                        <span class="field-name">Trip:</span>
                        <span class="field-value">{{ log.from_station }} to {{ log.to_station }}</span>
                    </div>
                    {% if log.notes %}
                    <div class="field">
                        <span class="field-name">Notes:</span>
                        <span class="field-value">{{ log.notes }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <script>
        // Check for URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const enableBackground = urlParams.get('background') === 'true';

        // Set up Intersection Observer
        const observerOptions = {
            root: null,
            rootMargin: '200px',
            threshold: 0
        };

        const observer = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
                const card = entry.target;
                const img = card.querySelector('.log-image');
                const background = card.querySelector('.log-background');

                if (entry.isIntersecting) {
                    const imageUrl = img.dataset.src;
                    if (imageUrl) {
                        img.src = imageUrl;
                        if (enableBackground) {
                            background.style.backgroundImage = `url(${imageUrl})`;
                        }
                    }
                } else {
                    img.src = '';
                    if (enableBackground) {
                        background.style.backgroundImage = '';
                    }
                }
            });
        }, observerOptions);

        // Observe all log cards
        document.querySelectorAll('.log-card').forEach(card => {
            observer.observe(card);
        });
    </script>
</body>
</html>